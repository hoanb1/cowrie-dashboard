<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cowrie Honeypot Dashboard - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS and JS for world map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @keyframes pulse-red {
            0%, 100% { background-color: rgba(239, 68, 68, 0.1); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
        }
        .alert-high { animation: pulse-red 2s infinite; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Custom map styles */
        .leaflet-container {
            background: #1f2937;
            border-radius: 8px;
        }
        .attack-marker {
            background: #ef4444;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: pulse-marker 2s infinite;
        }
        .attack-marker.heat-high {
            background: #dc2626;
            width: 16px;
            height: 16px;
        }
        .attack-marker.heat-medium {
            background: #f59e0b;
            width: 14px;
            height: 14px;
        }
        .attack-marker.heat-low {
            background: #10b981;
            width: 10px;
            height: 10px;
        }
        @keyframes pulse-marker {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        .country-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 min-h-screen text-white">
    <!-- Header -->
    <header class="glass-effect p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-shield-alt text-2xl text-blue-400"></i>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    Cowrie Honeypot Dashboard
                </h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="connection-status" class="flex items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span>
                    <span class="text-sm">Connected</span>
                </span>
                <button onclick="exportCredentials()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                    <i class="fas fa-download"></i>
                    <span>Export CSV</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
        <!-- Stats Overview -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Total Connections</p>
                        <p id="total-connections" class="text-3xl font-bold text-blue-400">0</p>
                    </div>
                    <i class="fas fa-network-wired text-3xl text-blue-400 opacity-50"></i>
                </div>
            </div>
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Failed Logins</p>
                        <p id="failed-logins" class="text-3xl font-bold text-red-400">0</p>
                    </div>
                    <i class="fas fa-times-circle text-3xl text-red-400 opacity-50"></i>
                </div>
            </div>
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Successful Logins</p>
                        <p id="successful-logins" class="text-3xl font-bold text-green-400">0</p>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-green-400 opacity-50"></i>
                </div>
            </div>
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Unique IPs</p>
                        <p id="unique-ips" class="text-3xl font-bold text-purple-400">0</p>
                    </div>
                    <i class="fas fa-globe text-3xl text-purple-400 opacity-50"></i>
                </div>
            </div>
        </section>

        <!-- Charts and Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Attack Timeline Chart -->
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-blue-400"></i>
                    Attack Timeline
                </h2>
                <div class="relative bg-gray-800 rounded" style="height: 300px; max-height: 300px; overflow: hidden;">
                    <canvas id="timeline-chart" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>

            <!-- World Attack Map -->
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-globe-americas mr-2 text-green-400"></i>
                    World Attack Map
                    <span class="ml-auto text-sm text-gray-400">
                        <span id="attack-count">0</span> attacks
                    </span>
                </h2>
                <div class="relative bg-gray-800 rounded" style="height: 300px; max-height: 300px; overflow: hidden;">
                    <div id="world-map" style="width: 100%; height: 100%;"></div>
                    <div id="map-tooltip" class="absolute bg-gray-900 text-white text-xs rounded px-2 py-1 pointer-events-none opacity-0 transition-opacity duration-200" style="z-index: 1000;"></div>
                </div>
                <div class="mt-2 flex justify-between text-xs text-gray-400">
                    <span>üî¥ Live attacks</span>
                    <span>Click markers for details</span>
                </div>
            </div>
        </div>

        <!-- Recent Attacks Table -->
        <div class="glass-effect p-6 rounded-xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-history mr-2 text-green-400"></i>
                    Recent Attacks
                </h2>
                <div class="flex space-x-2">
                    <select id="export-format" class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                    </select>
                    <button onclick="exportLogs()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                        <i class="fas fa-download"></i>
                        <span>Export Logs</span>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left p-2">Time</th>
                            <th class="text-left p-2">IP</th>
                            <th class="text-left p-2">Country</th>
                            <th class="text-left p-2">Event</th>
                            <th class="text-left p-2">Username</th>
                            <th class="text-left p-2">Password</th>
                        </tr>
                    </thead>
                    <tbody id="recent-attacks">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="glass-effect p-6 rounded-xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
                    Security Alerts
                </h2>
                <button onclick="exportAlerts()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                    <i class="fas fa-download"></i>
                    <span>Export Alerts</span>
                </button>
            </div>
            <div id="alerts-container" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Dynamic alerts -->
            </div>
        </div>

        <!-- Top Countries & Organizations -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-flag mr-2 text-purple-400"></i>
                    Top Countries
                </h2>
                <div id="top-countries"></div>
            </div>
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-building mr-2 text-orange-400"></i>
                    Top Organizations
                </h2>
                <div id="top-organizations"></div>
            </div>
        </div>

        <!-- Top Passwords & Users & IPs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-key mr-2 text-yellow-400"></i>
                    Top Passwords
                </h2>
                <div id="top-passwords"></div>
            </div>
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-user mr-2 text-blue-400"></i>
                    Top Users
                </h2>
                <div id="top-users"></div>
            </div>
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-network-wired mr-2 text-green-400"></i>
                    Top IPs
                </h2>
                <div id="top-ips"></div>
            </div>
        </div>
    </main>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="glass-effect p-6 rounded-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Export Credentials</h3>
            <div class="space-y-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="success-only" class="rounded">
                    <span>Export successful logins only</span>
                </label>
                <div class="flex space-x-4">
                    <button onclick="confirmExport()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg smooth-transition">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="closeExportModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg smooth-transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let timelineChart;
        let stats = {};
        let updateTimeout;
        let lastUpdateTime = 0;
        let worldMap;
        let attackMarkers = [];
        let heatmapEnabled = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            initializeMaps();
            loadInitialData();
        });

        // Socket.IO connection
        function initializeSocket() {
            console.log('üîå Initializing Socket.IO connection...');
            
            try {
                window.socket = io();
                
                window.socket.on('connect', function() {
                    console.log('‚úÖ Socket.IO connected successfully');
                    updateConnectionStatus(true);
                });
                
                window.socket.on('disconnect', function() {
                    console.log('‚ùå Socket.IO disconnected');
                    updateConnectionStatus(false);
                });
                
                window.socket.on('connect_error', function(error) {
                    console.log('‚ùå Socket.IO connection error:', error);
                    updateConnectionStatus(false);
                });
                
                window.socket.on('stats_update', function(data) {
                    console.log('üìä Received stats update:', data);
                    updateStats(data);
                });
                
                window.socket.on('new_attack', function(data) {
                    console.log('üéØ Received new attack:', data);
                    handleNewAttack(data);
                });
                
                window.socket.on('alert', function(alert) {
                    console.log('üö® Received alert:', alert);
                    addAlert(alert);
                });
                
            } catch (error) {
                console.log('‚ùå Socket.IO initialization error:', error);
                updateConnectionStatus(false);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.innerHTML = '<span class="w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span><span class="text-sm">Connected</span>';
            } else {
                status.innerHTML = '<span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span><span class="text-sm">Disconnected</span>';
            }
        }

        // Initialize charts
        function initializeCharts() {
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Attacks Over Time',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Initialize maps
        function initializeMaps() {
            console.log('üó∫Ô∏è Initializing world map...');
            
            // World Attack Map
            worldMap = L.map('world-map', {
                center: [20, 0],
                zoom: 2,
                zoomControl: true,
                attributionControl: true
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(worldMap);
            
            // Add initial attack markers from recent attacks
            if (stats.recent_attacks) {
                console.log('Adding initial attack markers:', stats.recent_attacks.length);
                stats.recent_attacks.forEach(attack => {
                    if (attack.latitude && attack.longitude) {
                        addAttackMarker(attack);
                    }
                });
            }
            
            console.log('‚úÖ World map initialized successfully');
        }

        // Add attack marker to map
        function addAttackMarker(attack) {
            if (!attack.latitude || !attack.longitude) return;
            
            const heatLevel = getHeatLevel(attack.ip);
            const markerClass = heatLevel === 'high' ? 'heat-high' : heatLevel === 'medium' ? 'heat-medium' : 'heat-low';
            
            // Create custom icon
            const icon = L.divIcon({
                className: `attack-marker ${markerClass}`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            // Add to world map
            const marker = L.marker([attack.latitude, attack.longitude], { icon })
                .addTo(worldMap)
                .bindPopup(`
                    <div class="text-xs">
                        <strong>IP:</strong> ${attack.ip}<br>
                        <strong>Country:</strong> ${attack.country || 'Unknown'}<br>
                        <strong>Time:</strong> ${new Date(attack.timestamp).toLocaleString()}<br>
                        <strong>Event:</strong> ${attack.event || 'Unknown'}<br>
                        <strong>Username:</strong> ${attack.username || 'N/A'}<br>
                        <strong>Password:</strong> ${attack.password || 'N/A'}
                    </div>
                `);
            
            attackMarkers.push({ marker, attack });
            updateAttackCount();
        }

        // Get heat level based on attack frequency
        function getHeatLevel(ip) {
            const recentAttacks = stats.recent_attacks || [];
            const ipAttacks = recentAttacks.filter(a => a.ip === ip);
            
            if (ipAttacks.length >= 5) return 'high';
            if (ipAttacks.length >= 3) return 'medium';
            return 'low';
        }

        // Update attack count display
        function updateAttackCount() {
            const count = attackMarkers.length;
            document.getElementById('attack-count').textContent = count;
        }

        // Reset map markers
        function resetMap() {
            attackMarkers.forEach(({ marker }) => {
                worldMap.removeLayer(marker);
            });
            attackMarkers = [];
            updateAttackCount();
            
            // Re-add from current stats
            if (stats.recent_attacks) {
                stats.recent_attacks.forEach(attack => {
                    if (attack.latitude && attack.longitude) {
                        addAttackMarker(attack);
                    }
                });
            }
        }

        // Toggle heatmap view
        function toggleHeatmap() {
            heatmapEnabled = !heatmapEnabled;
            
            if (heatmapEnabled) {
                // Show heatmap layer (simplified - just change marker sizes)
                attackMarkers.forEach(({ marker }) => {
                    const icon = marker.getIcon();
                    icon.options.iconSize = [20, 20];
                    marker.setIcon(icon);
                });
            } else {
                // Reset to normal sizes
                attackMarkers.forEach(({ marker }) => {
                    const icon = marker.getIcon();
                    const popupContent = marker.getPopup().getContent();
                    const ipMatch = popupContent.match(/IP: ([\d.]+)/);
                    if (ipMatch) {
                        const heatLevel = getHeatLevel(ipMatch[1]);
                        const size = heatLevel === 'high' ? 16 : heatLevel === 'medium' ? 14 : 12;
                        icon.options.iconSize = [size, size];
                        marker.setIcon(icon);
                    }
                });
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                console.log('üìä Loading initial data...');
                const response = await fetch('/api/stats');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                stats = await response.json();
                console.log('üìä Initial data loaded:', stats);
                updateStats(stats);
            } catch (error) {
                console.error('Error loading initial data:', error);
                // Set default empty values to prevent errors
                stats = {
                    top_countries: {},
                    top_organizations: {},
                    recent_attacks: [],
                    top_passwords: {},
                    total_connections: 0,
                    failed_logins: 0,
                    successful_logins: 0,
                    unique_ips: 0
                };
                updateStats(stats);
            }
        }

        // Debounced update function
        function debouncedUpdateStats(data, delay = 500) {
            console.log('debouncedUpdateStats called, delay:', delay);
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                console.log('Executing debounced update');
                updateStats(data);
            }, delay);
        }

        // Reset map markers
        function resetMap() {
            attackMarkers.forEach(({ marker }) => {
                worldMap.removeLayer(marker);
            });
            attackMarkers = [];
            updateAttackCount();
            
            // Re-add from current stats
            if (stats.recent_attacks) {
                stats.recent_attacks.forEach(attack => {
                    if (attack.latitude && attack.longitude) {
                        addAttackMarker(attack);
                    }
                });
            }
        }

        // Update stats
        function updateStats(data) {
            console.log('updateStats called with:', data);
            
            // Comprehensive null check - allow empty objects but reject null/undefined
            if (data === null || data === undefined || typeof data !== 'object') {
                console.log('updateStats: Invalid data provided, skipping update');
                return;
            }
            
            // Update statistics with null checks
            document.getElementById('total-connections').textContent = data.total_connections || 0;
            document.getElementById('failed-logins').textContent = data.failed_logins || 0;
            document.getElementById('successful-logins').textContent = data.successful_logins || 0;
            document.getElementById('unique-ips').textContent = data.unique_ips || 0;
            
            // Update top passwords with null check
            if (data.top_passwords && typeof data.top_passwords === 'object') {
                updateTopPasswords(data.top_passwords);
            }
            
            // Update recent attacks with null check
            if (data.recent_attacks && Array.isArray(data.recent_attacks)) {
                updateRecentAttacks(data.recent_attacks);
            }
            
            // Update top countries with null check
            if (data.top_countries && typeof data.top_countries === 'object') {
                updateTopCountries(data.top_countries);
            }
            
            // Update top organizations with null check
            if (data.top_organizations && typeof data.top_organizations === 'object') {
                updateTopOrganizations(data.top_organizations);
            }
            
            // Update top IPs with null check
            if (data.top_ips && typeof data.top_ips === 'object') {
                updateTopIPs(data.top_ips);
            }
            
            // Update top users with null check
            if (data.top_users && typeof data.top_users === 'object') {
                updateTopUsers(data.top_users);
            }
            
            // Update timeline chart with null check
            if (data.recent_attacks && Array.isArray(data.recent_attacks)) {
                updateTimelineChart(data.recent_attacks);
            }
        }

        // Update stat card with animation
        function updateStatCard(elementId, value) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            const increment = (value - currentValue) / 20;
            let current = currentValue;
            
            const animation = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= value) || (increment < 0 && current <= value)) {
                    element.textContent = value.toLocaleString();
                    clearInterval(animation);
                } else {
                    element.textContent = Math.round(current).toLocaleString();
                }
            }, 50);
        }

        // Update top passwords
        function updateTopPasswords(passwords) {
            const container = document.getElementById('top-passwords');
            if (!passwords || typeof passwords !== 'object') {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No passwords data available</div>';
                return;
            }
            container.innerHTML = Object.entries(passwords)
                .sort((a, b) => b[1] - a[1]) // Sort by count descending
                .slice(0, 200) // Top 200 passwords
                .map(([password, count], index) => `
                    <div class="flex justify-between items-center p-2 hover:bg-white hover:bg-opacity-10 rounded smooth-transition">
                        <span class="flex items-center">
                            <span class="text-yellow-400 mr-2">#${index + 1}</span>
                            <span class="font-mono text-sm">${password || '<empty>'}</span>
                        </span>
                        <span class="bg-blue-600 px-2 py-1 rounded text-xs">${count}</span>
                    </div>
                `).join('');
        }

        // Update recent attacks
        function updateRecentAttacks(attacks) {
            const tbody = document.getElementById('recent-attacks');
            tbody.innerHTML = attacks.slice(0, 20).map(attack => `
                <tr class="border-b border-gray-800 hover:bg-white hover:bg-opacity-5 smooth-transition">
                    <td class="p-2 text-xs">${formatTime(attack.timestamp)}</td>
                    <td class="p-2 font-mono text-sm">${attack.ip}</td>
                    <td class="p-2">${attack.country || 'Unknown'}</td>
                    <td class="p-2">
                        <span class="px-2 py-1 rounded text-xs ${
                            attack.event === 'connection' ? 'bg-blue-600' : 
                            attack.event === 'login.success' ? 'bg-green-600' : 'bg-red-600'
                        }">
                            ${attack.event || 'Unknown'}
                        </span>
                    </td>
                    <td class="p-2 font-mono text-sm">${attack.username || '-'}</td>
                    <td class="p-2 font-mono text-sm">${truncateText(attack.password || '-', 15)}</td>
                </tr>
            `).join('');
        }

        // Update top countries
        function updateTopCountries(countries) {
            const container = document.getElementById('top-countries');
            if (!countries || typeof countries !== 'object') {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No countries data available</div>';
                return;
            }
            
            // Create chart container
            container.innerHTML = `
                <div class="relative" style="height: 300px;">
                    <canvas id="countries-chart"></canvas>
                </div>
            `;
            
            // Prepare chart data
            const chartData = Object.entries(countries)
                .sort((a, b) => b[1] - a[1]) // Sort by count descending
                .slice(0, 10); // Top 10 countries for chart
            
            const labels = chartData.map(([country]) => country);
            const data = chartData.map(([, count]) => count);
            
            // Create chart
            const ctx = document.getElementById('countries-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.countriesChart) {
                window.countriesChart.destroy();
            }
            
            window.countriesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attack Count',
                        data: data,
                        backgroundColor: 'rgba(168, 85, 247, 0.6)',
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Update top organizations
        function updateTopOrganizations(organizations) {
            const container = document.getElementById('top-organizations');
            if (!organizations || typeof organizations !== 'object') {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No organizations data available</div>';
                return;
            }
            
            // Create chart container
            container.innerHTML = `
                <div class="relative" style="height: 300px;">
                    <canvas id="organizations-chart"></canvas>
                </div>
            `;
            
            // Prepare chart data
            const chartData = Object.entries(organizations)
                .sort((a, b) => b[1] - a[1]) // Sort by count descending
                .slice(0, 10); // Top 10 organizations for chart
            
            const labels = chartData.map(([org]) => org || 'Unknown');
            const data = chartData.map(([, count]) => count);
            
            // Create chart
            const ctx = document.getElementById('organizations-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.organizationsChart) {
                window.organizationsChart.destroy();
            }
            
            window.organizationsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attack Count',
                        data: data,
                        backgroundColor: 'rgba(249, 115, 22, 0.6)',
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Update top IPs
        function updateTopIPs(ips) {
            const container = document.getElementById('top-ips');
            if (!ips || typeof ips !== 'object') {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No IPs data available</div>';
                return;
            }
            container.innerHTML = Object.entries(ips)
                .sort((a, b) => b[1] - a[1]) // Sort by count descending
                .slice(0, 200) // Top 200 IPs
                .map(([ip, count], index) => `
                    <div class="flex justify-between items-center p-2 hover:bg-white hover:bg-opacity-10 rounded smooth-transition">
                        <span class="flex items-center">
                            <span class="text-green-400 mr-2">#${index + 1}</span>
                            <span class="font-mono text-sm">${ip}</span>
                        </span>
                        <span class="bg-green-600 px-2 py-1 rounded text-xs">${count}</span>
                    </div>
                `).join('');
        }

        // Update top users
        function updateTopUsers(users) {
            const container = document.getElementById('top-users');
            if (!users || typeof users !== 'object') {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No users data available</div>';
                return;
            }
            container.innerHTML = Object.entries(users)
                .sort((a, b) => b[1] - a[1]) // Sort by count descending
                .slice(0, 200) // Top 200 users
                .map(([user, count], index) => `
                    <div class="flex justify-between items-center p-2 hover:bg-white hover:bg-opacity-10 rounded smooth-transition">
                        <span class="flex items-center">
                            <span class="text-blue-400 mr-2">#${index + 1}</span>
                            <span class="font-mono text-sm">${user || '<empty>'}</span>
                        </span>
                        <span class="bg-blue-600 px-2 py-1 rounded text-xs">${count}</span>
                    </div>
                `).join('');
        }

        // Update timeline chart
        function updateTimelineChart(attacks) {
            console.log('updateTimelineChart called with:', attacks?.length || 0, 'attacks');
            
            if (!timelineChart) {
                console.log('timelineChart not initialized');
                return;
            }
            
            // Rate limiting - don't update too frequently
            const now = Date.now();
            if (now - lastUpdateTime < 1000) {
                console.log('Rate limited update');
                return; // Max 1 update per second
            }
            lastUpdateTime = now;
            
            if (!attacks || attacks.length === 0) {
                console.log('No attacks data, clearing chart');
                // Clear chart if no data
                timelineChart.data.labels = [];
                timelineChart.data.datasets[0].data = [];
                timelineChart.update('none');
                return;
            }
            
            // Group attacks by hour
            const hourlyData = {};
            const hoursWithData = new Set();
            
            attacks.forEach(attack => {
                const hour = new Date(attack.timestamp).getHours();
                hourlyData[hour] = (hourlyData[hour] || 0) + 1;
                hoursWithData.add(hour);
            });
            
            // Only show hours that have data, sorted
            const sortedHours = Array.from(hoursWithData).sort((a, b) => a - b);
            const labels = sortedHours.map(hour => `${hour}:00`);
            const data = sortedHours.map(hour => hourlyData[hour] || 0);
            
            console.log('Chart data:', { labels, data });
            
            timelineChart.data.labels = labels;
            timelineChart.data.datasets[0].data = data;
            timelineChart.update('none'); // Update without animation for performance
        }

        // Handle new attack
        function handleNewAttack(data) {
            console.log('handleNewAttack called with:', data);
            
            // Add attack marker to maps if coordinates available
            if (data.latitude && data.longitude) {
                addAttackMarker(data);
            } else if (data.ip) {
                // Try to get coordinates from existing data
                const existingAttack = stats.recent_attacks?.find(a => a.ip === data.ip);
                if (existingAttack && existingAttack.latitude && existingAttack.longitude) {
                    addAttackMarker({...data, latitude: existingAttack.latitude, longitude: existingAttack.longitude});
                }
            }
            
            if (data.type === 'cowrie.session.connect') {
                // Flash connection indicator
                const connectionsCard = document.querySelector('#total-connections').closest('.stat-card');
                connectionsCard.classList.add('alert-high');
                setTimeout(() => connectionsCard.classList.remove('alert-high'), 2000);
            }
            
            // Update timeline chart with new attack
            if (data.timestamp) {
                updateTimelineChart(stats.recent_attacks || []);
            }
            
            // Use debounced update to prevent excessive calls
            console.log('Calling debouncedUpdateStats');
            debouncedUpdateStats(data.stats);
        }

        // Add alert
        function addAlert(alert) {
            const container = document.getElementById('alerts-container');
            const alertElement = document.createElement('div');
            alertElement.className = `p-3 rounded-lg smooth-transition ${
                alert.level === 'HIGH' ? 'bg-red-600 bg-opacity-20 border border-red-600' :
                alert.level === 'MEDIUM' ? 'bg-yellow-600 bg-opacity-20 border border-yellow-600' :
                'bg-blue-600 bg-opacity-20 border border-blue-600'
            }`;
            
            alertElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-xs font-semibold ${
                                alert.level === 'HIGH' ? 'text-red-400' :
                                alert.level === 'MEDIUM' ? 'text-yellow-400' :
                                'text-blue-400'
                            }">${alert.level}</span>
                            <span class="text-xs text-gray-400">${formatTime(alert.timestamp)}</span>
                        </div>
                        <p class="text-sm">${alert.message}</p>
                        <p class="text-xs text-gray-400 mt-1">IP: ${alert.ip} | ${alert.country}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.insertBefore(alertElement, container.firstChild);
            
            // Keep only latest 10 alerts
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // Export functions
        function exportCredentials() {
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        function confirmExport() {
            const successOnly = document.getElementById('success-only').checked;
            const url = `/api/export/credentials?success_only=${successOnly}`;
            
            window.open(url, '_blank');
            closeExportModal();
        }

        function exportLogs() {
            const format = document.getElementById('export-format').value;
            const url = `/api/export/logs?format=${format}&limit=1000`;
            window.open(url, '_blank');
        }

        function exportAlerts() {
            const url = '/api/export/alerts?limit=1000';
            window.open(url, '_blank');
        }

        // Utility functions
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
    </script>
</body>
</html>
